---
- name: Copy RHEL9-CIS-Audit folder to /opt/ on target host
  ansible.builtin.copy:
    src: RHEL9-CIS-Audit
    dest: "/opt/"
    owner: root
    group: root
    mode: '0755'

- name: Copy Results splitter file for GOSS no dupes
  ansible.builtin.copy:
    src: "{{splitter_file_for_goss_nodupes}}"
    dest: "/opt/{{splitter_file_for_goss_nodupes}}"
    owner: root
    group: root
    mode: '0755'

- name: Copy Results splitter file for GOSS with dupes
  ansible.builtin.copy:
    src: "{{splitter_file_for_goss_wdupes}}"
    dest: "/opt/{{splitter_file_for_goss_wdupes}}"
    owner: root
    group: root
    mode: '0755'

- name: Ensure run_audit.sh is executable
  ansible.builtin.file:
    path: "{{rhel9_cis_audit_path_and_file}}"
    owner: root
    group: root
    mode: '0755'

- name: Ensure Goss binary is installed
  ansible.builtin.get_url:
    url: https://github.com/goss-org/goss/releases/download/v0.4.4/goss-linux-amd64
    dest: "{{goss_destination_path}}"
    mode: '0755'
    owner: root
    group: root

# - name: Execute run_audit.sh
#   ansible.builtin.command: bash {{rhel9_cis_audit_path_and_file}}
#   args:
#     chdir: "/opt/{{rhel9_cis_audit}}"

# - name: Run split-results-nodupes.py on the latest audit JSON file
#   ansible.builtin.shell: |
#     # Find the latest audit file based on the largest number at the end of filename
#     latest_file=$(ls /opt/audit_localhost.localdomain-CIS-RHEL9_*.json 2>/dev/null | sort -t_ -k5 -n | tail -n 1)

#     if [ -n "$latest_file" ]; then
#       echo "ğŸ“„ Detected latest audit file: $latest_file"
#       python3 /opt/split-results-nodupes.py "$latest_file"
#     else
#       echo "âŒ No audit files found in /opt/"
#       exit 1
#     fi
#   args:
#     chdir: /opt
#   register: split_results_output
#   changed_when: false

# - name: Show which audit file was parsed
#   ansible.builtin.debug:
#     msg: "{{ split_results_output.stdout }}"  

- name: Find all CIS audit files on remote host
  ansible.builtin.find:
    paths: "{{ rhel9cis_results_dir }}"
    patterns: "{{ rhel9cis_results_pattern }}"
  register: cis_audit_files

- name: Ensure results directory for the host exists
  ansible.builtin.file:
    path: "{{ rhel9cis_output_dir }}/{{ inventory_hostname }}/"
    state: directory
    mode: '0755'

- name: Fetch all CIS audit results from managed host
  ansible.builtin.fetch:
    src: "{{ item.path }}"
    dest: "{{ rhel9cis_output_dir }}/{{ inventory_hostname }}/"
    flat: yes
  loop: "{{ cis_audit_files.files }}"